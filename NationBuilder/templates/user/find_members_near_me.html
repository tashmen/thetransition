{% include "thetransitionglobaluser" %}
{% include "thetransitionextheader" %}
{% include "thetransitiongooglemapheader" %}
<script type="text/javascript">
    Ext.onReady(function() {
		var cooperativeType = {
			'Social Co-op': 'social',
			'Consumer Co-op': 'consumer',
			'Producer Co-op': 'producer',
			'Worker Co-op': 'worker',
			'Retail or Purchasing Co-op': 'purchasing',
			'Credit Union Co-op': 'creditunion'
		};
		var establishedSuffix = ' (Established)';
		var developmentSuffix = ' (In Development)';
		var imageType = '.png';
		var imageEstablishedSuffix = 'established';
		var imageDevelopmentSuffix = 'development';
		
		var tagToImageMapping = { 
			key: []
		};
		
		for(var key in cooperativeType)
		{
			tagToImageMapping.key.push({name: key + developmentSuffix, icon: cooperativeType[key] + imageDevelopmentSuffix + imageType});
			tagToImageMapping.key.push({name: key + establishedSuffix, icon: cooperativeType[key] + imageEstablishedSuffix + imageType});
		}
		
		Ext.define('Key', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'id'
				},
				{
					name: 'name'
				},
				{
					name: 'icon'
				}
			],
			proxy: {
				type: 'memory',
				reader: {
					type: 'json',
					rootProperty: 'key'
				}
			}
		});
		
		var keyStore = Ext.create('Ext.data.Store', {
			storeId:'keyStore',
			model: 'Key',
			remoteSort: false,
			remoteFilter: false,
			sorters: [{
				 property: 'name',
				 direction: 'ASC'
			}],
			pageSize: 0,
			data: tagToImageMapping
		});
	
		var peopleData = { 
			users: [
				{% for signup in site.recent_supporters limit:2000 %}
				{% if signup.custom_values.remove_from_map != "1" %}
				{% if forloop.index0 > 0 %}
				,
				{% endif %}
				{
					id: '{{signup.id}}',
					linkedfullname: '{{signup.published_name_linked}}',
					name: '{{signup.published_name}}',
					email: '{{signup.email}}',
					mobile: '{{signup.mobile_number}}',
					isVolunteer: '{{signup.is_volunteer?}}',
					profileImage: '{{ signup.bigger_profile_image }}',
					state: '{{signup.address.state}}',
					country: '{{signup.address.country_code}}',
					latitude: '{{signup.address.lat}}',
					longitude: '{{signup.address.lng}}',
					distance: 0,//Distance in miles
					tags: '{{signup.tag_list}}'
				}
				{% endif %}
				{% endfor %}
			]
		};
		
		Ext.define('Users', {
			extend: 'Ext.data.Model',
			fields: [
				{
					name: 'id'
				},
				{
					name: 'name'
				},
				{
					name: 'linkedfullname'
				},
				{
					name: 'email'
				},
				{
					name: 'mobile'
				},
				{
					name: 'isVolunteer'
				},
				{
					name: 'profileImage'
				},
				{
					name: 'state'
				},
				{
					name: 'country'
				},
				{
					name: 'latitude'
				},
				{
					name: 'longitude'
				},
				{
					name: 'distance',
					calculate: function (data) {
						return Transition.user.calculateDistance(data.latitude, data.longitude);
					}
				},
				{
					name: 'tags'
				},
				{
					name: 'markertitle',
					calculate: function (data) {
						return data.name;
					}
				},
				{
					name: 'icon',
					calculate: function (data) {
						var tagList = data.tags.split(', ');
						for(var i = 0; i < tagList.length; i++)
						{
							var index = keyStore.find('name', tagList[i])
							if(index != -1)
								return keyStore.getAt(index).get('icon');
						}
						return 'googlemapman.gif';
					}
				}
			],
			proxy: {
				type: 'memory',
				reader: {
					type: 'json',
					rootProperty: 'users'
				}
			}
		});
		
		var usersStore = Ext.create('Ext.data.Store', {
			storeId:'usersStore',
			model: 'Users',
			remoteSort: false,
			remoteFilter: false,
			pageSize: 0,
			data: peopleData
		});
		
		
		function GetUsersForm()
		{
			return Ext.create(Ext.form.Panel,{
				items: [
				{
					xtype: 'fieldset',
					collapsible: false,
					border: false,
					margin: '5',
					defaults: {
						labelAlign: 'right'
					},
					items:[
					{
						xtype: 'container',
						layout: 'column',
						collapsible: false,
						border: false,
						margin: 0,
						padding: 0,
						defaults: {
							labelAlign: 'right'
						},
						items:[
						{
							xtype: 'field',
							name: 'profileImage',
							fieldSubTpl: '<div>{value}</div>',
							columnWidth: 0.2
						},
						{
							xtype: 'container',
							layout: 'form',
							collapsible: false,
							border: false,
							margin: 0,
							padding: 0,
							columnWidth: 0.75,
							defaults: {
								labelAlign: 'right'
							},
							items:[
							{
								xtype: 'field',
								fieldLabel: 'Name',
								name: 'linkedfullname',
								fieldSubTpl: '<div>{value}</div>'
							},
							{
								xtype: 'textfield',
								fieldLabel: 'Email',
								name: 'email'
							},
							{
								xtype: 'textfield',
								fieldLabel: 'Mobile',
								name: 'mobile'
							}
							]
						}
						]
					}
					]
				}
				]
			});
		}
		
		var mapPanel = Ext.create('Ext.ux.MapPanel',{
			renderTo: 'map_panel',
			title: "Nearby Members",
			height: 550,
			markerWindowHeight: 150,
			markerWindowWidth: 400,
			keyStore: Ext.StoreManager.get('keyStore'),
			mapStore: Ext.StoreManager.get('usersStore'),
			filterMenuConfig: {
				filters:[
					{
						text: 'Distance',
						emptyText: 'Enter distance in miles.',
						dataIndex: 'distance',
						operator: '<=',
						type: 'number'
					}
				]
			},
			getMapStoreForm: GetUsersForm
		});
		
		
	
	
	});
</script>




{% include "breadcrumbs" %}

{% if page.headline.size > 0 %}
<h2 class="headline">{{ page.headline }}</h2>
{% endif %}

<div id="content">
  
  <div id="intro" class="intro">
    <div class="text-content">
      {{ page.basic.content }}
    </div>
  </div>
  <div id="map_panel"></div>
    
	<br>
    <h2><a href="/spaces"><span><span>Spaces</span></span></a></h2>
	<br>
	<h2><a href="/member_skills"><span><span>Skills</span></span></a></h2>
	<br>
	<h2><a href="/objects"><span><span>Objects</span></span></a></h2>
  
  {% if page.tags_count > 0 %}
  <div class="page-tags">
    {% include "page_tags" with page %}
  </div>
  {% endif %}
  
  {% if page.is_homepage? == true and site.page_tags contains "homepage" %}
  {% tag "homepage" with "homepage_widget" %}
  {% endif %}
  
  <div class="like-page">
    <strong>Do you like this page?</strong>
    {% include "like_page" %}
  </div>
  
  {% if page.show_stream? %}
  {% include "page_stream" %}
  {% endif %}
  
</div>
{% include "donateLink" with "pay_what_you_want" %} 